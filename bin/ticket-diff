#!/bin/bash
# Find all commits containing a ticket ID and show their diffs
# Usage: ticket-diff <TICKET_ID>

set -e

show_help() {
    cat << 'EOF'
Usage: ticket-diff <TICKET_ID>

Search for all commits containing a ticket ID and display their full diffs.

This tool searches across all branches for commits mentioning the specified
ticket ID and displays the commit information and diff for each match.

Examples:
  ticket-diff INF-123
  ticket-diff PROJ-456
  ticket-diff help

The output includes:
  - Commit hash
  - Timestamp
  - Full git diff for each commit
EOF
}

# Check for help flag
if [[ "$1" == "help" || "$1" == "--help" || "$1" == "-h" ]]; then
    show_help
    exit 0
fi

local ticket_id="$1"

# 1. Validate input argument
if [ -z "$ticket_id" ]; then
    echo "Usage: ticket-diff <TICKET_ID>"
    echo "Example: ticket-diff INF-123"
    exit 1
fi

# 2. Check if inside a Git repository
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "Error: Not inside a Git repository."
    exit 1
fi

echo "Searching for commits containing '$ticket_id'..."
echo

# 3. Collect commits containing the ticket ID
# --all: Search across all branches, tags, etc.
# --grep="$ticket_id": Filter commit messages for the ticket ID.
# --pretty=format:"%H %ad": Format output to show commit hash and author date.
# --date=iso: Use ISO 8601 format for the date.
local commits_info=$(git log --all --grep="$ticket_id" --pretty=format:"%H %ad" --date=iso)

if [ -z "$commits_info" ]; then
    echo "No commits found containing '$ticket_id'."
    exit 0
fi

echo "--- Found Commits ---"
echo

# 4. Iterate through each found commit
while IFS= read -r line; do
    local commit_hash=$(echo "$line" | awk '{print $1}')
    # Extract the timestamp (everything after the first space)
    local commit_timestamp=$(echo "$line" | cut -d' ' -f2-)

    echo "Commit Hash: $commit_hash"
    echo "Timestamp: $commit_timestamp"
    echo "--------------------------------------------------"
    echo "Git Diff Output for Commit $commit_hash:"
    # `git show` displays the commit message, author, date, and then the diff.
    # This provides full context for each commit's changes.
    git show "$commit_hash"
    echo "=================================================="
    echo
done <<< "$commits_info"

echo "--- End of Commit List ---"

