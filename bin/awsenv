#!/bin/bash
# AWS profile switcher with SSO support
# Usage: awsenv [profile-name]
# thanks sam and rory

set -e

show_help() {
    cat << 'EOF'
Usage: awsenv [profile-name]

AWS profile switcher with automatic SSO login support.

Commands:
  awsenv                List all available AWS profiles
  awsenv <profile>      Switch to specified AWS profile
  awsenv help           Show this help message

Examples:
  awsenv                      # List available profiles
  awsenv production           # Switch to production profile
  awsenv dev                  # Switch to dev profile

The tool will automatically attempt SSO login if authentication is needed.
Profile information is read from ~/.aws/config and ~/.aws/credentials
EOF
}

# Check for help flag
if [[ "$1" == "help" || "$1" == "--help" || "$1" == "-h" ]]; then
    show_help
    exit 0
fi

# If no profile argument is provided, list all available profiles and show current env
if [[ -z "$1" ]]; then
    echo "üìã Available AWS Profiles:"
    echo "------------------------"

    # Show current profile if set
    if [[ -n "$AWS_PROFILE" ]]; then
      echo "üü¢ Current Profile: $AWS_PROFILE"
      echo "------------------------"
    fi

    # List profiles from config file
    if [[ -f "$HOME/.aws/config" ]]; then
      grep "\[profile" "$HOME/.aws/config" | sed 's/\[profile \(.*\)\]/\1/' | while read -r profile; do
        if [[ "$profile" == "$AWS_PROFILE" ]]; then
          echo "  ‚úì $profile"
        else
          echo "  ‚Ä¢ $profile"
        fi
      done
    fi

    # Add default profile if it exists in credentials file
    if [[ -f "$HOME/.aws/credentials" ]] && grep -q "^\[default\]" "$HOME/.aws/credentials"; then
      if [[ "default" == "$AWS_PROFILE" ]]; then
        echo "  ‚úì default"
      else
        echo "  ‚Ä¢ default"
      fi
    fi

    # List other profiles from credentials file
    if [[ -f "$HOME/.aws/credentials" ]]; then
      grep "\[" "$HOME/.aws/credentials" | sed 's/\[\(.*\)\]/\1/' | grep -v '^default$' | while read -r profile; do
        if [[ "$profile" == "$AWS_PROFILE" ]]; then
          echo "  ‚úì $profile"
        else
          echo "  ‚Ä¢ $profile"
        fi
      done
    fi
    echo "üìù Usage: awsenv <profile-name>"
    exit 0
fi

profile="$1"
config_path="$HOME/.aws/config"
creds_path="$HOME/.aws/credentials"

# Check if profile exists in either config or credentials
if ! grep -q "\[profile $profile\]" "$config_path" && ! grep -q "\[$profile\]" "$creds_path" && [[ "$profile" != "default" ]]; then
  echo "‚ùå Profile '$profile' not found"
  echo "   Check your AWS configuration files:"
  echo "   - $config_path"
  echo "   - $creds_path"
  exit 1
fi

# Set the AWS profile
export AWS_PROFILE="$profile"
echo "‚úÖ Switched to AWS profile: $AWS_PROFILE"

# Get caller identity and handle SSO login if needed
if ! identity=$(aws sts get-caller-identity --profile "$AWS_PROFILE" --output json 2>/dev/null); then
  echo "‚ö†Ô∏è  Authentication needed, attempting SSO login..."
  if aws sso login --profile "$AWS_PROFILE"; then
    echo "‚úÖ SSO login successful"
    identity=$(aws sts get-caller-identity --profile "$AWS_PROFILE" --output json)
  else
    echo "‚ùå SSO login failed"
    exit 1
  fi
fi

echo "üîë Current AWS Identity:"
echo "$identity" | jq '. | {Account, Arn}'

# Update right prompt to show active AWS profile
RPROMPT='$( [[ -n $AWS_PROFILE ]] && echo "%F{242}(aws:$AWS_PROFILE)%f" )'
